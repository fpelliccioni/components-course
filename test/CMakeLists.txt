# Components-Course
#
# Copyright Fernando Pelliccioni 2016-2018
# Distributed under the Boost Software License, Version 1.0. (See accompanying
# file LICENSE_1_0.txt or copy at http://www.boost.org/LICENSE_1_0.txt)

enable_testing()

add_custom_target(tests ALL
    COMMAND ${CMAKE_CTEST_COMMAND} -C Debug --output-on-failure -R "test.+"
    COMMENT "Build and run all the unit tests.")

function(course_add_test name)
    # add_executable(test.${name} EXCLUDE_FROM_ALL ${name}.cpp ../src/benchmark/instrumented.cpp)
    add_executable(test.${name} EXCLUDE_FROM_ALL ${name}.cpp)
    add_test(NAME test.${name} COMMAND test.${name})
    add_dependencies(tests test.${name})
endfunction()

file(GLOB_RECURSE COURSE_TEST_SOURCES
     RELATIVE ${CMAKE_CURRENT_LIST_DIR}
     "*.cpp")

foreach(file IN LISTS COURSE_TEST_SOURCES)
    string(REGEX REPLACE "\\.cpp$" "" name ${file})
    string(REGEX REPLACE "/" "." name ${name})
    course_add_test(${name})
endforeach()

# Test for multiple definition errors
file(GLOB COURSE2_HEADERS
     RELATIVE "${PROJECT_SOURCE_DIR}/include"
     "${PROJECT_SOURCE_DIR}/include/course/*.hpp")

file(GLOB COURSE_HEADERS
     RELATIVE "${PROJECT_SOURCE_DIR}/include"
     "${PROJECT_SOURCE_DIR}/include/course/algorithm/*.hpp")

set(CONTENTS "// This file is auto-generated by CMake to test for multiple definition errors.\n")
foreach(HEADER ${COURSE2_HEADERS} ${COURSE_HEADERS})
    message("${HEADER}")
    if(NOT "${HEADER}" STREQUAL "course/algorithm/concepts_undef.hpp")
        set(CONTENTS "${CONTENTS}#include <${HEADER}>\n")
    endif()
endforeach()

message("${CONTENTS}")

set(SOURCE_ONE "${CMAKE_CURRENT_BINARY_DIR}/translation_unit_one.cpp")
file(WRITE "${SOURCE_ONE}" "${CONTENTS}\nint main() { return 0; }")

set(SOURCE_TWO "${CMAKE_CURRENT_BINARY_DIR}/translation_unit_two.cpp")
file(WRITE "${SOURCE_TWO}" "${CONTENTS}")

add_executable(test.multiple.definitions EXCLUDE_FROM_ALL ${SOURCE_ONE} ${SOURCE_TWO})
add_test(NAME test.multiple.definitions COMMAND test.multiple.definitions)
add_dependencies(tests test.multiple.definitions)
